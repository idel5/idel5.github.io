<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo Design Selector</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load p5.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
      /* Custom styles for better visual appeal */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Light gray background */
      }
      .card-grid-container {
        max-height: calc(100vh - 4rem); /* Adjust based on header/footer */
        overflow-y: auto;
      }
      .card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
      }
      .card.selected {
        border: 4px solid #4f46e5; /* Indigo ring for selection */
        box-shadow: 0 0 0 4px #818cf8;
      }
      /* Custom thumb color for the size slider */
      .slider-thumb-indigo::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
      }
      .slider-thumb-indigo::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        border: none;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2">
      Demo Design Selector
    </h1>

    <div id="app-container" class="flex flex-col lg:flex-row gap-8">
      <!-- 1. Card Selection Grid (Left Side) -->
      <div
        class="lg:w-1/3 card-grid-container p-4 bg-white rounded-xl shadow-lg"
      >
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          Template Library
        </h2>
        <div id="card-grid" class="grid grid-cols-2 gap-4">
          <!-- Cards will be injected here by JavaScript -->
        </div>
      </div>

      <!-- 2. P5.js Design Area (Right Side) -->
      <div class="lg:w-2/3 p-4 bg-white rounded-xl shadow-lg flex flex-col">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Design Canvas</h2>
        <div
          id="p5-canvas-container"
          class="flex-grow flex items-center justify-center bg-gray-100 border border-gray-300 rounded-lg min-h-[400px]"
        >
          <!-- P5.js canvas will be inserted here -->
        </div>
        <p class="text-sm text-gray-500 mt-3 text-center mb-4">
          Click a template on the left to load it onto this canvas. **Drag the
          text or uploaded image** directly on the canvas to reposition it!
        </p>

        <!-- Main Controls Container -->
        <div class="border-t border-gray-200 mt-4 pt-4 space-y-6">

          <!-- TEXT Controls Panel -->
          <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">
              Customize Text Overlay
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
              <!-- Text Input -->
              <div class="col-span-2">
                <label
                  for="text-input"
                  class="block text-sm font-medium text-gray-700"
                  >Text Content</label
                >
                <input
                  type="text"
                  id="text-input"
                  value="Your Custom Text"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                />
              </div>

              <!-- Font Selector -->
              <div>
                <label
                  for="font-select"
                  class="block text-sm font-medium text-gray-700"
                  >Font Family</label
                >
                <select
                  id="font-select"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white"
                >
                  <option value="sans-serif">Sans-serif (Inter/Arial)</option>
                  <option value="serif">Serif (Times New Roman)</option>
                  <option value="monospace">Monospace (Courier)</option>
                  <option value="cursive">Cursive</option>
                </select>
              </div>

              <!-- Color Selector -->
              <div>
                <label
                  for="color-input"
                  class="block text-sm font-medium text-gray-700"
                  >Text Color</label
                >
                <input
                  type="color"
                  id="color-input"
                  value="#000000"
                  class="mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-1 cursor-pointer"
                />
              </div>

              <!-- Size Slider -->
              <div>
                <label
                  for="font-size"
                  class="block text-sm font-medium text-gray-700"
                  >Size (<span id="size-value">48</span>px)</label
                >
                <input
                  type="range"
                  id="font-size"
                  min="16"
                  max="120"
                  value="48"
                  class="mt-1 w-full appearance-none bg-gray-200 rounded-lg h-2 slider-thumb-indigo"
                />
              </div>
            </div>
          </div>
          
          <!-- NEW: User Image Controls Panel -->
          <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">
              User Image Upload & Transform
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
              <!-- Image Upload Input -->
              <div>
                <label for="image-upload" class="block text-sm font-medium text-gray-700">Upload Image (PNG/JPG)</label>
                <input type="file" id="image-upload" accept="image/png, image/jpeg, image/jpg" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
              </div>
              
              <!-- Image Scale Slider -->
              <div>
                  <label for="image-scale" class="block text-sm font-medium text-gray-700">Image Scale (<span id="scale-value">100</span>%)</label>
                  <input type="range" id="image-scale" min="10" max="300" value="100" class="mt-1 w-full appearance-none bg-gray-200 rounded-lg h-2 slider-thumb-indigo">
              </div>

              <!-- Reset Image Position Button -->
              <div>
                   <button id="reset-image-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Reset Image Position</button>
              </div>
            </div>
          </div>

        </div> <!-- End Main Controls Container -->
      </div>
    </div>

    <script>
      // --- 1. DATA AND STATE MANAGEMENT ---

      const cardsData = [
        // Assuming /images/bgX.jpg are your custom image paths
        { id: 1, name: "Modern Floral", url: "/images/bg1.jpg" },
        { id: 2, name: "Elegant Minimal", url: "/images/bg2.jpg" },
        { id: 3, name: "Watercolor Abstract", url: "/images/bg3.jpg" },
        { id: 4, name: "Simple Typography", url: "/images/bg4.jpg" },
        { id: 5, name: "Geometric Pattern", url: "/images/bg5.jpg" },
        { id: 6, name: "Bright Celebration", url: "/images/bg6.jpg" },
      ];

      let loadedImage = null; // Background template image
      let userImage = null; // New: User uploaded image
      let selectedCardId = 1;
      let p5Instance = null;

      // State for custom text overlay
      let textState = {
        content: "Your Custom Text",
        font: "sans-serif",
        size: 48,
        color: "#000000",
        x: 0,
        y: 0,
        isDragging: false,
        offsetX: 0,
        offsetY: 0,
      };
      
      // New: State for user uploaded image overlay
      let userImageState = {
          x: 50,
          y: 50,
          originalWidth: 0, // Store original dimensions after load
          originalHeight: 0,
          currentScale: 1.0, // Multiplier for size
          isDragging: false,
          offsetX: 0,
          offsetY: 0,
      };

      // --- 2. DOM RENDERING AND INTERACTION ---

      const cardGrid = document.getElementById("card-grid");
      const p5CanvasContainer = document.getElementById("p5-canvas-container");

      /**
       * Updates the selected card ID and loads the new background image.
       */
      function selectCard(id) {
        selectedCardId = id;
        renderCards();

        const selected = cardsData.find(card => card.id === id);
        const imageUrl = selected ? selected.url : "/images/bg1.jpg";

        if (p5Instance) {
            loadedImage = p5Instance.loadImage(
                imageUrl,
                () => {
                    console.log("Template image loaded successfully: " + imageUrl);
                    p5Instance.redraw();
                },
                () => {
                    console.error("Failed to load template image: " + imageUrl);
                }
            );
        }
      }

      /**
       * Renders the cards from cardsData into the grid container.
       */
      function renderCards() {
        cardGrid.innerHTML = "";

        cardsData.forEach((card) => {
          const isSelected = card.id === selectedCardId;
          const cardElement = document.createElement("div");
          cardElement.id = `card-${card.id}`;
          cardElement.className = `card relative p-4 rounded-lg flex flex-col items-center justify-center text-center ${
            isSelected
              ? "selected ring-4 ring-indigo-500"
              : "bg-white hover:bg-gray-100"
          } transition`;
          cardElement.onclick = () => selectCard(card.id);

          let visualHtml = `
                    <img
                        src="${card.url}"
                        alt="${card.name} template"
                        class="w-16 h-16 object-cover rounded-md shadow-inner"
                        onerror="this.onerror=null; this.src='https://placehold.co/64x64/E0E0E0/333333?text=Template'"
                    >
                `;

          cardElement.innerHTML = `
                    <div class="mb-2 p-2">${visualHtml}</div>
                    <span class="text-sm font-medium text-gray-800">${card.name}</span>
                `;

          cardGrid.appendChild(cardElement);
        });
      }

      // Initial render of cards
      renderCards();

      // --- Input Event Listeners ---
      
      // Text Controls
      document.getElementById("text-input").addEventListener("input", (e) => {
        textState.content = e.target.value;
        if (p5Instance) p5Instance.redraw();
      });

      document.getElementById("font-select").addEventListener("change", (e) => {
        textState.font = e.target.value;
        if (p5Instance) p5Instance.redraw();
      });

      document.getElementById("color-input").addEventListener("input", (e) => {
        textState.color = e.target.value;
        if (p5Instance) p5Instance.redraw();
      });

      const fontSizeInput = document.getElementById("font-size");
      const sizeValueSpan = document.getElementById("size-value");

      fontSizeInput.addEventListener("input", (e) => {
        textState.size = parseInt(e.target.value, 10);
        sizeValueSpan.textContent = textState.size;
        if (p5Instance) p5Instance.redraw();
      });
      
      // New: Image Upload Handler
      document.getElementById("image-upload").addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file && p5Instance) {
              const reader = new FileReader();
              reader.onload = (readerEvent) => {
                  const dataURL = readerEvent.target.result;
                  userImage = p5Instance.loadImage(dataURL,
                      (img) => {
                          console.log("User image loaded successfully.");
                          // Set initial dimensions and reset position
                          userImageState.originalWidth = img.width;
                          userImageState.originalHeight = img.height;
                          userImageState.x = p5Instance.width / 2 - (img.width * userImageState.currentScale) / 2;
                          userImageState.y = p5Instance.height / 2 - (img.height * userImageState.currentScale) / 2;
                          p5Instance.redraw();
                      },
                      () => {
                          console.error("Failed to load user image.");
                      }
                  );
              };
              reader.readAsDataURL(file);
          }
      });

      // New: Image Scale Slider
      const imageScaleInput = document.getElementById('image-scale');
      const scaleValueSpan = document.getElementById('scale-value');
      
      imageScaleInput.addEventListener('input', (e) => {
          userImageState.currentScale = parseInt(e.target.value, 10) / 100;
          scaleValueSpan.textContent = e.target.value;
          if (p5Instance) p5Instance.redraw();
      });

      // New: Reset Image Position Button
      document.getElementById('reset-image-btn').addEventListener('click', () => {
          if (userImage && p5Instance) {
              // Recalculate position to center the current scaled image
              const currentWidth = userImageState.originalWidth * userImageState.currentScale;
              const currentHeight = userImageState.originalHeight * userImageState.currentScale;
              userImageState.x = p5Instance.width / 2 - currentWidth / 2;
              userImageState.y = p5Instance.height / 2 - currentHeight / 2;
              p5Instance.redraw();
          }
      });


      // --- 3. P5.JS SKETCH ---

      const sketch = (p) => {
        let canvas;
        let containerWidth, containerHeight;
        let textBounds = {}; 
        
        // Flag to track which element is currently being dragged
        let draggingElement = null; // 'text' or 'image'

        // p5.js preload function to load the initial image
        p.preload = () => {
          const initialCard = cardsData.find(c => c.id === selectedCardId);
          loadedImage = p.loadImage(
            initialCard ? initialCard.url : "/images/bg1.jpg",
            () => { console.log("Initial template image loaded successfully."); },
            () => { console.error("Failed to load initial template image."); }
          );
        };

        p.setup = () => {
          containerWidth = p5CanvasContainer.offsetWidth;
          containerHeight = p5CanvasContainer.offsetHeight;

          canvas = p.createCanvas(containerWidth, containerHeight);
          canvas.parent("p5-canvas-container");

          // Initialize text position to center of canvas
          textState.x = p.width / 2;
          textState.y = p.height / 2;

          p.angleMode(p.DEGREES);
          p.noLoop();
        };

        p.windowResized = () => {
          containerWidth = p5CanvasContainer.offsetWidth;
          containerHeight = p5CanvasContainer.offsetHeight;
          p.resizeCanvas(containerWidth, containerHeight);

          // Constrain element positions
          textState.x = p.constrain(textState.x, 0, p.width);
          textState.y = p.constrain(textState.y, 0, p.height);
          userImageState.x = p.constrain(userImageState.x, -userImageState.originalWidth * userImageState.currentScale, p.width);
          userImageState.y = p.constrain(userImageState.y, -userImageState.originalHeight * userImageState.currentScale, p.height);

          p.redraw();
        };

        // Helper function to check if mouse is over the text
        const isMouseOverText = () => {
          if (!textState.content) return false;
          // Check based on text position, size, and width
          return (
            p.mouseX > textBounds.x - textBounds.width / 2 &&
            p.mouseX < textBounds.x + textBounds.width / 2 &&
            p.mouseY > textBounds.y - textState.size &&
            p.mouseY < textBounds.y + textState.size / 2
          );
        };
        
        // New: Helper function to check if mouse is over the user image
        const isMouseOverUserImage = () => {
            if (!userImage) return false;
            const currentWidth = userImageState.originalWidth * userImageState.currentScale;
            const currentHeight = userImageState.originalHeight * userImageState.currentScale;
            
            return (
                p.mouseX > userImageState.x &&
                p.mouseX < userImageState.x + currentWidth &&
                p.mouseY > userImageState.y &&
                p.mouseY < userImageState.y + currentHeight
            );
        }

        p.mousePressed = () => {
            // Priority: Check image first, then text
            if (isMouseOverUserImage()) {
                draggingElement = 'image';
                userImageState.isDragging = true;
                userImageState.offsetX = p.mouseX - userImageState.x;
                userImageState.offsetY = p.mouseY - userImageState.y;
                p.redraw();
                return false;
            } else if (isMouseOverText()) {
                draggingElement = 'text';
                textState.isDragging = true;
                textState.offsetX = p.mouseX - textState.x;
                textState.offsetY = p.mouseY - textState.y;
                p.redraw();
                return false;
            }
        };

        p.mouseDragged = () => {
            if (draggingElement === 'image' && userImageState.isDragging) {
                userImageState.x = p.mouseX - userImageState.offsetX;
                userImageState.y = p.mouseY - userImageState.offsetY;
                p.redraw();
            } else if (draggingElement === 'text' && textState.isDragging) {
                textState.x = p.mouseX - textState.offsetX;
                textState.y = p.mouseY - textState.offsetY;
                p.redraw();
            }
        };

        p.mouseReleased = () => {
            textState.isDragging = false;
            userImageState.isDragging = false;
            draggingElement = null;
            p.redraw();
        };

        p.draw = () => {
          // 1. Background: Clear the canvas
          p.background(240);
          p.noStroke();

          // 2. Draw the loaded template image
          if (loadedImage && loadedImage.width > 0) {
            let imgRatio = loadedImage.width / loadedImage.height;
            let canvasRatio = p.width / p.height;
            let drawWidth, drawHeight;
            let x, y;

            if (canvasRatio > imgRatio) {
              drawHeight = p.height;
              drawWidth = drawHeight * imgRatio;
            } else {
              drawWidth = p.width;
              drawHeight = drawWidth / imgRatio;
            }

            x = (p.width - drawWidth) / 2;
            y = (p.height - drawHeight) / 2;

            p.image(loadedImage, x, y, drawWidth, drawHeight);
          }

          // 3. Draw the custom text overlay (Drawn second)
          if (textState.content.length > 0) {
            p.fill(textState.color);
            p.textSize(textState.size);
            p.textAlign(p.CENTER, p.TOP);
            p.textFont(textState.font);
            p.text(textState.content, textState.x, textState.y);

            // Calculate and store text bounds
            textBounds.width = p.textWidth(textState.content);
            textBounds.x = textState.x;
            textBounds.y = textState.y;
          }
          
          // 4. Draw the user uploaded image (Drawn last, on top)
          if (userImage && userImage.width > 0) {
              const currentWidth = userImageState.originalWidth * userImageState.currentScale;
              const currentHeight = userImageState.originalHeight * userImageState.currentScale;

              p.image(
                  userImage,
                  userImageState.x,
                  userImageState.y,
                  currentWidth,
                  currentHeight
              );
          }


          // 5. Cursor handling (Priority: Image drag > Text drag)
          if (userImageState.isDragging || isMouseOverUserImage()) {
              p.cursor(p.MOVE);
          } else if (textState.isDragging || isMouseOverText()) {
              p.cursor(p.MOVE);
          } else {
              p.cursor(p.ARROW);
          }
        };
      };

      // Initialize the p5.js sketch when the window loads
      window.onload = () => {
        p5Instance = new p5(sketch);
      };
    </script>
  </body>
</html>
